# راهنمای پیکربندی متغیرهای محیطی

این سند تمام متغیرهای محیطی موردنیاز پروژه را تشریح می‌کند و سناریوهای تست دستی برای سرویس‌های پرداخت و پیامک را پوشش می‌دهد. برای شروع، فایل `.env` خود را بر اساس جدول‌های زیر مقداردهی کنید.

> **نکته:** می‌توانید از فایل [`../.env.example`](../.env.example) به عنوان قالب اولیه استفاده کنید.

## فهرست متغیرهای محیطی

| دسته | کلید | توضیح | مقدار نمونه | اجباری |
| --- | --- | --- | --- | --- |
| Core | `SECRET_KEY` | کلید مخفی جنگو. مقدار یکتا و طولانی تولید کنید. | `django-insecure-...` | بله |
| Core | `DEBUG` | فعال‌سازی حالت دیباگ (فقط برای توسعه). | `false` | خیر |
| Database | `DB_NAME` | نام پایگاه‌داده PostgreSQL | `alovakil` | بله |
| Database | `DB_USER` | کاربر پایگاه‌داده | `alovakil` | بله |
| Database | `DB_PASSWORD` | رمز کاربر پایگاه‌داده | `super-secret` | بله |
| Database | `DB_HOST` | میزبان پایگاه‌داده | `127.0.0.1` | بله (پیش‌فرض `localhost`) |
| Database | `DB_PORT` | پورت پایگاه‌داده | `5432` | بله (پیش‌فرض `5432`) |
| Payments | `IDPAY_API_KEY` | کلید API درگاه IDPay | `test-xxxxxxxx` | بله |
| Payments | `IDPAY_SANDBOX` | فعال‌سازی sandbox برای تست پرداخت | `true` | توصیه‌شده در محیط تست |
| Payments | `IDPAY_API_URL` | آدرس پایه API درگاه | `https://api.idpay.ir/v1.1` | خیر |
| Payments | `PAYMENT_AMOUNT_MULTIPLIER` | ضریب دلخواه برای مبلغ نهایی | `1` | خیر |
| SMS | `SMS_PROVIDER` | نام تأمین‌کننده پیامک (`console`, `kavenegar`, ...) | `console` | خیر |
| SMS | `SMS_API_KEY` | کلید API سرویس پیامک (برای provider≠console) | `sample-key` | بله (برای تولید) |
| SMS | `SMS_SENDER` | شماره فرستنده پیامک | `1000596446` | خیر |
| Email | `EMAIL_HOST` | آدرس SMTP | `smtp.gmail.com` | بله |
| Email | `EMAIL_PORT` | پورت SMTP | `587` | بله |
| Email | `EMAIL_USE_TLS` | استفاده از TLS | `true` | بله |
| Email | `EMAIL_USE_SSL` | استفاده از SSL (در صورت عدم استفاده از TLS) | `false` | خیر |
| Email | `EMAIL_HOST_USER` | کاربر/آدرس ایمیل فرستنده | `noreply@example.com` | بله |
| Email | `EMAIL_HOST_PASSWORD` | رمز یا App Password SMTP | `secret` | بله |
| Email | `DEFAULT_FROM_EMAIL` | آدرس پیش‌فرض فرستنده | `noreply@example.com` | توصیه‌شده |
| Redis & Celery | `REDIS_URL` | آدرس Redis برای cache و Celery | `redis://127.0.0.1:6379/1` | خیر |
| Channels | `USE_INMEMORY_CHANNEL_LAYER` | استفاده از لایه In-memory (توسعه) | `true` | خیر |
| JWT | `JWT_SIGNING_KEY` | کلید امضای JWT (در صورت جداسازی از SECRET_KEY) | `another-secret` | خیر |
| AI | `OPENAI_API_KEY` | کلید OpenAI برای دستیار هوشمند | `sk-...` | خیر (برای غیرفعال‌سازی AI خالی بگذارید) |

## مراحل ایجاد فایل `.env`

1. فایل `.env` را در ریشه‌ی مخزن ایجاد کنید.
2. مقادیر جدول بالا را وارد کنید. می‌توانید از قالب آماده `.env.example` شروع کرده و مقادیر را به صورت امن جایگزین کنید.
3. پس از ذخیره فایل، دستور `python manage.py check_env` را اجرا کنید تا از تکمیل بودن متغیرهای ضروری مطمئن شوید.

## راهنمای پرداخت و پیامک

### تست sandbox پرداخت (IDPay)

1. متغیر `IDPAY_SANDBOX` را روی `true` قرار دهید و از کلید تست ارائه‌شده توسط IDPay استفاده کنید.
2. اطمینان حاصل کنید که `IDPAY_API_URL` روی آدرس sandbox (به طور معمول همان مقدار پیش‌فرض) تنظیم شده باشد.
3. یک تراکنش آزمایشی از طریق endpoint پرداخت برنامه اجرا کنید. در صورت نیاز از کارت‌های آزمایشی معرفی‌شده توسط IDPay استفاده نمایید.
4. لاگ‌های اپلیکیشن و پاسخ IDPay را بررسی کنید تا وضعیت `200` یا `100` (موفق) را مشاهده کنید.

### تست ارسال پیامک

### پیکربندی سرویس پیامک

- مقدار پیش‌فرض `SMS_PROVIDER` برابر با `console` است و پیامک‌ها صرفاً در خروجی استاندارد چاپ می‌شوند.
- برای استفاده از سرویس‌های واقعی (مانند `kavenegar`) لازم است `SMS_API_KEY` را در تنظیمات قرار دهید و در صورت نیاز مقدار `SMS_SENDER` را مشخص کنید. در صورت نبود کلید API، ماژول پیامک با خطای پیکربندی متوقف می‌شود.
- اگر بستهٔ پایتونی مربوط به provider (برای مثال `kavenegar`) نصب نشده باشد، پیش از ارسال پیامک خطای مناسب دریافت می‌کنید.

### تست ارسال پیامک

1. اگر از سرویس واقعی استفاده می‌کنید، `SMS_PROVIDER` را متناسب با پیاده‌سازی تغییر دهید (برای مثال `kavenegar`) و `SMS_API_KEY` و `SMS_SENDER` معتبر وارد کنید.
2. در محیط توسعه می‌توانید مقدار `SMS_PROVIDER=console` را نگه دارید تا پیامک‌ها در خروجی کنسول ثبت شوند.
3. یک درخواست ارسال پیامک (برای مثال از مسیرهای reminder یا اعلان) اجرا کرده و خروجی را بررسی کنید. در صورت استفاده از provider واقعی، وضعیت پاسخ سرویس را بررسی نمایید.

## بررسی خودکار متغیرها

دستور زیر وضعیت متغیرهای حیاتی را گزارش می‌کند. در صورت نبود هر متغیر ضروری، اجرای فرمان با خطا متوقف خواهد شد.

```bash
python manage.py check_env
```

گزارش تولید‌شده دسته‌بندی شده است (Core، Database، Payments، SMS، Email و ...). خطوط با نماد `✗` نشان‌دهنده متغیرهای ضروری مفقود هستند.
